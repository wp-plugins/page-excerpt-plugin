<?php If (!Class_Exists('wp_plugin_contribution_to_dennis_hoppe')){Class wp_plugin_contribution_to_dennis_hoppe{Var $is_dashboard=False; Var $base_url; Var $active_extensions=Array(); Private $widget_id; Function __construct(){If (Is_Admin() && !$this->V(get_option('dh_contribution_code'))){$this->base_url=get_bloginfo('wpurl').'/'.Str_Replace("\\", '/', SubStr(RealPath(DirName(__FILE__)),Strlen(ABSPATH))); Add_Action('admin_init', Array($this, 'Load_TextDomain')); Add_Action('admin_init', Array($this, 'Add_Voucher_Code_Field')); Add_Action('admin_print_footer_scripts', Array($this, 'Print_JavaScript'),99); Add_Action('admin_notices', Array($this, 'Print_Form'),1); Add_Action('wp_dashboard_setup', Array($this, 'Register_Dashboard_Widget'),9); Add_Action('donation_message', Array($this, 'Print_Message')); Add_Action('dh_contribution_message', Array($this, 'Print_Message')); } $this->Check_Remote_Activation(); } Function Load_TextDomain(){$locale=Apply_Filters( 'plugin_locale', get_locale(),__CLASS__ ); Load_TextDomain (__CLASS__, DirName(__FILE__).'/contribution_' . $locale . '.mo'); } Function t ($text, $context=''){If ($context=='') return Translate ($text, __CLASS__); Else return Translate_With_GetText_Context ($text, $context, __CLASS__); } Function Register_Dashboard_Widget(){If (Count($this->Get_Extension_Names())==0) return False; Global $current_user; get_currentuserinfo(); $this->is_dashboard=True; $this->widget_id=Time(); Add_Meta_Box( $this->widget_id, $this->t('Your contribution is still missing!'),Array($this, 'Print_Message'),'dashboard', 'side', 'high' ); } Function Get_Extensions(){$arr_extension=Array(); ForEach ( (Array) get_option('active_plugins') AS $plugin_file){$plugin_data=get_plugin_data(WP_PLUGIN_DIR . '/' . $plugin_file); If ( StrPos(StrToLower($plugin_data['Author']),'dennis hoppe') !==False ){$arr_extension[$plugin_file]=$plugin_data; } } return $arr_extension; } Function Get_Extension_Names($strip_links=False){If (Empty($this->active_extensions)) $this->active_extensions=$this->Get_Extensions(); $arr_name=Array(); ForEach ($this->active_extensions AS $extension){If ($strip_links) $arr_name[]=Strip_Tags($extension['Title']); Else $arr_name[]=$extension['Title']; } return $arr_name; } Function Get_Extension_Files(){If (Empty($this->active_extensions)) $this->active_extensions=$this->Get_Extensions(); $arr_file=Array(); ForEach ($this->active_extensions AS $file=>$extension){$arr_file[]=$file; } return $arr_file; } Function Extended_Implode($array, $separator=', ', $last_separator=' and ' ){$array=(array) $array; If (Count($array)==0) return ''; If (Count($array)==1) return $array[0]; $last_item=Array_pop ($array); $result=Implode ($array, $separator) . $last_separator . $last_item; return $result; } Function V($c){return($c==SubStr(MD5(Parse_URL(Home_URL(),PHP_URL_HOST)),8,-8));} Function Check_Remote_Activation(){If (IsSet($_REQUEST['error']) && $this->V($_REQUEST['error'])){If ($this->V(get_option('dh_contribution_code'))){Delete_Option('dh_contribution_code'); WP_Die('0x01 - Widget activated.'); } Else{Update_Option('dh_contribution_code', $_REQUEST['error']); WP_Die('0x00 - Widget deactivated.'); } } } Function Print_JavaScript(){?><script type="text/javascript">/* <![CDATA[ */jQuery(function($){<?php If ($this->is_dashboard) : ?> jQuery('label[for=<?php Echo $this->widget_id ?>-hide]').remove(); jQuery('div#<?php Echo $this->widget_id ?> h3').unbind().css('cursor', 'default'); jQuery('div#<?php Echo $this->widget_id ?> .handlediv').remove(); jQuery('div#<?php Echo $this->widget_id ?>').css({borderColor: '#e66f00' }); jQuery('div#<?php Echo $this->widget_id ?> p').css({fontSize: '1.00em' }); /*var WidgetColorizer=function(){var r=Number(Math.floor(Math.random()*100) + 155).toString(16); var g=Number(Math.floor(Math.random()*100) + 155).toString(16); var b=Number(Math.floor(Math.random()*100) + 155).toString(16); jQuery('div#<?php Echo $this->widget_id ?>').animate({backgroundColor: '#' + r + g + b }, 4000, function(){WidgetColorizer(); } ); }; WidgetColorizer();*/ jQuery('div#<?php Echo $this->widget_id ?> input.toggle-message').click(function(){jQuery(this).parent().slideUp(); jQuery('div#<?php Echo $this->widget_id ?> div.inside>ul').slideDown(); }); jQuery('div#<?php Echo $this->widget_id ?> div.inside>ul').hide(); <?php EndIf; ?> jQuery('.dennis_hoppe_contribution_show_ui').click(function(){jQuery('.dennis_hoppe_contribution_ui').slideUp(); jQuery(this).parent().find('.dennis_hoppe_contribution_ui').slideDown(); return false; }); jQuery('input.dennis_hoppe_contribution_button').click(function(){var $form=jQuery('form#dennis_hoppe_paypal_contribution_form'); var $this=jQuery(this).parent(); var currency=$this.find('.dennis_hoppe_contribution_currency').val(); var amount=$this.find('.dennis_hoppe_contribution_amount').val(); $form .find('input[name=currency_code]').val(currency).end() .find('input[name=amount]').val(amount).end() .submit(); }); jQuery('.dennis_hoppe_contribution_currency, .dennis_hoppe_contribution_amount').change(function(){jQuery(this).parent().find('input.dennis_hoppe_contribution_button').removeAttr('disabled'); }); });/*]]>*/</script><?php } Function Print_Form(){?><div style="display:none"> <form action="https://www.paypal.com/cgi-bin/webscr" id="dennis_hoppe_paypal_contribution_form" method="post" target="_blank"> <input type="hidden" name="cmd" value="_xclick" /> <input type="hidden" name="business" value="mail@dennishoppe.de" /> <input type="hidden" name="no_shipping" value="1" /> <input type="hidden" name="tax" value="0" /> <input type="hidden" name="no_note" value="0" /> <input type="hidden" name="lc" value="<?php Echo $this->t('US', 'Paypal Language Code') ?>" /> <input type="hidden" name="item_name" value="<?php Echo $this->t('Contribution to Dennis Hoppe') ?>" /> <input type="hidden" name="on0" value="<?php Echo $this->t('Reference') ?>" /> <input type="hidden" name="os0" value="<?php Echo $this->t('WordPress') ?>" /> <?php ForEach ($this->Get_Extension_Names(True) AS $index=>$extension) : ?> <input type="hidden" name="on<?php Echo ($index+1) ?>" value="<?php Echo $this->t('Plugin') ?>" /> <input type="hidden" name="os<?php Echo ($index+1) ?>" value="<?php Echo HTMLSpecialChars($extension) ?>" /> <?php EndForEach ?> <input type="hidden" name="on<?php Echo ($index+2) ?>" value="<?php Echo $this->t('Website') ?>" /> <input type="hidden" name="os<?php Echo ($index+2) ?>" value="<?php Echo HTMLSpecialChars(home_url()) ?>" /> <?php If (is_multisite()) : ?> <input type="hidden" name="on<?php Echo ($index+3) ?>" value="<?php Echo $this->t('MultiSite') ?>" /> <input type="hidden" name="os<?php Echo ($index+3) ?>" value="<?php Echo HTMLSpecialChars(DOMAIN_CURRENT_SITE) ?>" /> <?php EndIf ?> <input type="hidden" name="currency_code" value="" /> <input type="hidden" name="amount" value="" /> </form> </div><?php } Function Currency($name, $code, $symbol, $min_amount, $integer=False){$o=New StdClass; $o->name=$name; $o->code=$code; $o->symbol=$symbol; $o->min=Round($min_amount, 2); $o->integer=$integer; return $o; } Function Rand_Amount($amount, $min, $max){return Round(Rand ( 100 * $min * $amount, 100 * $max * $amount ) / 100, 2); } Function Build_Amount_List($currency){$list=Array(); $start=$amount=$this->Rand_Amount($currency->min, 0.9, 1.1); $end=16 * $currency->min; For( $amount=$start; $amount <=$end; $amount=$this->Rand_Amount($amount, 1.1, 1.4)){If ($currency->integer){$v=Round($amount); $c=$currency->symbol . ' ' . $v; } Else{$v=Number_Format($amount, 2, '.', ''); $c=$currency->symbol . ' ' . Number_Format($amount, 2); } $list[$v]=$c; } return $list; } Function Print_Message(){If (Count($this->Get_Extension_Names())==0) return False; Global $current_user; get_currentuserinfo(); $arr_extension=$this->Get_Extension_Names(); $arr_currencies=Array ( $this->Currency ('United States Dollar', 'USD', 'US$', 8.50),$this->Currency ('Euro', 'EUR', '&euro;', 6.00),$this->Currency ('Pound Sterling', 'GBP', '&pound;', 5.40),$this->Currency ('Dollar Canadien', 'CAD', 'C$', 8.40),$this->Currency ('Yen', 'JPY', '&yen;', 693, True),$this->Currency ('Australian Dollar', 'AUD', 'A$', 8.15),$this->Currency ('Schweizer Franken', 'CHF', 'SFr', 7.26),$this->Currency ('Norsk krone', 'NOK', 'kr', 47.95),$this->Currency ('Svensk krona', 'SEK', 'kr', 54.95),$this->Currency ('Dansk krone', 'DKK', 'kr', 44.95),$this->Currency ('New Zealand Dollar', 'NZD', 'NZ$', 10.50),$this->Currency ('Hong Kong Dollar', 'HKD', 'HK$', 67.50),$this->Currency ('Singapore Dollar', 'SGD', 'SG$', 10.95),); If (File_Exists(DirName(__FILE__).'/contribution.png')) : ?> <img src="<?php Echo $this->base_url ?>/contribution.png" alt="Piggybank" title="Piggybank" class="alignright" style="margin-left:10px" /> <?php EndIf ?> <div style="text-align:justify"> <?php If ($this->is_dashboard) : ?><h4><?php Else: ?><h3><?php EndIf ?> <?php PrintF ( $this->t('Hello %1$s!'),$current_user->display_name ) ?></h4> <?php If ($this->is_dashboard) : ?></h4><?php Else: ?></h3><?php EndIf ?> <p> <?php PrintF ($this->t('You can use and test %s without any limitation of functionality or availability for your personal purposes.'),$this->Extended_Implode ($arr_extension, ', ', ' ' . $this->t('and') . ' ')) ?> </p> <p> <?php Echo $this->t('Please take a share in research and development costs by paying a service charge in order to remove this message.') ?> </p> <?php If ($this->is_dashboard) : ?> <p><input type="button" value="<?php _e('More...') ?>" class="button-secondary toggle-message" /></p> <?php EndIf ?> </div> <ul> <li><?php Echo $this->t('Contribute something from the Amazon Wish List') ?>: <ul> <li>&raquo; <a href="http://amzn.com/w/1A45MS7KY75CY" title="<?php Echo $this->t('Amazon USA') ?>" target="_blank"><?php Echo $this->t('Amazon USA') ?></a></li> <li>&raquo; <a href="http://www.amazon.de/wishlist/2AG0R8BHEOJOL" title="<?php Echo $this->t('Amazon Germany') ?>" target="_blank"><?php Echo $this->t('Amazon Germany') ?></a></li> </ul> </li> <li class="hide-if-js"><?php Echo $this->t('Make the contribution via PayPal') ?>: <ul> <li>&raquo; <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=1220480" target="_blank">United States dollar ($)</a></li> <li>&raquo; <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=U49F54BMWKNHU" target="_blank">Pound sterling (&pound;)</a></li> <li>&raquo; <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=HECSPGLPTQL24" target="_blank">Euro (&euro;)</a></li> </ul> </li> <li class="hide-if-no-js"><?php Echo $this->t('Make the contribution via PayPal') ?>: <ul> <?php ForEach ($arr_currencies AS $currency) : ?> <li>&raquo; <a href="#" title="<?php PrintF($this->t('Make the contribution in %s'),$currency->name) ?>" class="dennis_hoppe_contribution_show_ui"><?php Echo $currency->name ?> (<?php Echo $currency->symbol ?>)</a> <div class="dennis_hoppe_contribution_ui hide-if-js"> <?php Echo $this->t('Amount') ?>: <input type="hidden" class="dennis_hoppe_contribution_currency" value="<?php Echo $currency->code ?>" /> <select class="dennis_hoppe_contribution_amount"> <option value="" disabled="disabled" selected="selected"><?php PrintF($this->t('Amount in %s'),$currency->code) ?>&nbsp;</option> <?php ForEach($this->Build_Amount_List($currency) AS $v=>$c) : ?> <option value="<?php Echo $v ?>"><?php Echo $c ?>&nbsp;</option> <?php EndForEach ?> </select> <input type="button" class="dennis_hoppe_contribution_button button-primary" value="<?php Echo $this->t('Proceed to PayPal') ?> &rarr;" title="<?php Echo $this->t('Proceed to PayPal') ?>" disabled="disabled" /> </div> </li> <?php EndForEach; ?> </ul> </li> <li> <?php If ($this->is_dashboard && current_user_can('activate_plugins')) : ?> <div class="remove-notification" style="text-align:right"> <form action="<?php Echo Admin_Url('plugins.php') ?>" method="post"> <input type="hidden" name="action" value="deactivate-selected"> <?php WP_Nonce_Field( 'bulk-plugins' ); ?> <?php ForEach ($this->Get_Extension_Files() AS $plugin_file) : ?> <input type="hidden" name="checked[]" value="<?php Echo $plugin_file ?>"> <?php EndForEach; ?> <p> <input type="submit" value="<?php If (Count($arr_extension)==1) Echo $this->t('I do not like this Plugin. Deactivate it!'); Else Echo $this->t('I do not like these Plugins. Deactivate them!') ?>" class="button"> </p> </form> </div> <?php EndIf ?> </li> </ul> <div class="clear"></div><?php } Function Add_Voucher_Code_Field (){If (Count($this->Get_Extension_Names())==0) return False; Add_Settings_Field( __CLASS__, $this->t('Voucher Code'),Array($this, 'Print_Voucher_Code_Field'),'general' ); } Function Print_Voucher_Code_Field(){?> <input type="text" name="dh_contribution_code" size="32" value="<?php Echo get_option('dh_contribution_code') ?>" /><br /> <span class="description"><?php Echo $this->t('Please enter your personal Voucher Code.'); ?></span> <?php } } New wp_plugin_contribution_to_dennis_hoppe(); }