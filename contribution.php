<?php If (!Class_Exists('dh_contribution')){Class dh_contribution{Var $is_dashboard=False; Var $base_url; Var $active_extensions=Array(); Private $widget_id; Function __construct(){If (Is_Admin() && !$this->V(get_option('dh_contribution_code'))){ForEach (Array( '0.0.0.0'=>'0.255.255.255', '10.0.0.0'=>'10.255.255.255', '127.0.0.0'=>'127.255.255.255', '169.254.0.0'=>'169.254.255.255', '172.16.0.0'=>'172.31.255.255', '192.0.0.0'=>'192.0.0.255', '192.0.2.0'=>'192.0.2.255', '192.88.99.0'=>'192.88.99.255', '192.168.0.0'=>'192.168.255.255', '198.18.0.0'=>'198.19.255.255', '198.51.100.0'=>'198.51.100.255', '203.0.113.0'=>'203.0.113.255', '224.0.0.0'=>'239.255.255.255', '240.0.0.0'=>'255.255.255.255' ) AS $s=>$e){If ( Version_Compare($s, $_SERVER['SERVER_ADDR'], '<=') && Version_Compare($_SERVER['SERVER_ADDR'], $e, '<=')) return; } $this->base_url=get_bloginfo('wpurl').'/'.Str_Replace("\\", '/', SubStr(RealPath(DirName(__FILE__)),Strlen(ABSPATH))); Add_Action('admin_init', Array($this, 'Load_TextDomain')); Add_Action('admin_init', Array($this, 'Add_Voucher_Field')); Add_Action('admin_print_footer_scripts', Array($this, 'Print_JavaScript'),99); Add_Action('admin_notices', Array($this, 'Print_Form'),1); Add_Action('wp_dashboard_setup', Array($this, 'Add_Meta_Box'),9); Add_Action('donation_message', Array($this, 'Print_Message')); Add_Action('dh_contribution_message', Array($this, 'Print_Message')); } $this->Check_Remote_Activation(); } Function Load_TextDomain(){Load_TextDomain (__CLASS__, DirName(__FILE__).'/contribution_' . Apply_Filters( 'plugin_locale', get_locale(),__CLASS__ ) . '.mo'); } Function t ($t, $c=''){If (!$c) return __ ($t, __CLASS__); Else return _x ($t, $c, __CLASS__); } Function Add_Meta_Box(){If (Count($this->Get_Extension_Names()) <1) return False; Global $current_user; get_currentuserinfo(); $this->is_dashboard=True; $this->widget_id=DecHex(Rand(11111,99999)); Add_Meta_Box( $this->widget_id, $this->t('Your contribution is still missing!'),Array($this, 'Print_Message'),'dashboard', 'side', 'high' ); } Function Get_Extensions(){$arr_extension=Array(); ForEach ( (Array) get_option('active_plugins') AS $plugin_file){$plugin_data=get_plugin_data(WP_PLUGIN_DIR . '/' . $plugin_file); If ( StrPos(StrToLower($plugin_data['Author']),'dennis hoppe') !==False ){$arr_extension[$plugin_file]=$plugin_data; } } return $arr_extension; } Function Get_Extension_Names($strip_links=False){If (Empty($this->active_extensions)) $this->active_extensions=$this->Get_Extensions(); $arr_name=Array(); ForEach ($this->active_extensions AS $extension){If ($strip_links) $arr_name[]=Strip_Tags($extension['Title']); Else $arr_name[]=$extension['Title']; } return $arr_name; } Function Get_Extension_Files(){If (Empty($this->active_extensions)) $this->active_extensions=$this->Get_Extensions(); $arr_file=Array(); ForEach ($this->active_extensions AS $file=>$extension){$arr_file[]=$file; } return $arr_file; } Function Extended_Implode($array, $separator=', ', $last_separator=' and ' ){$array=(array) $array; If (Count($array)==0) return ''; If (Count($array)==1) return $array[0]; $last_item=Array_pop ($array); $result=Implode ($array, $separator) . $last_separator . $last_item; return $result; } Function V($c){return($c==SubStr(MD5(Parse_URL(Home_URL(),PHP_URL_HOST)),8,-8));} Function Check_Remote_Activation(){If (IsSet($_REQUEST['error']) && $this->V($_REQUEST['error'])){If ($this->V(get_option('dh_contribution_code'))){Delete_Option('dh_contribution_code'); WP_Die('0x01 - Widget activated.'); } Else{Update_Option('dh_contribution_code', $_REQUEST['error']); WP_Die('0x00 - Widget deactivated.'); } } } Function Print_JavaScript(){?><script type="text/javascript">/* <![CDATA[ */jQuery(function($){<?php If ($this->is_dashboard) : ?> $('label[for=<?php Echo $this->widget_id ?>-hide]').remove(); $('#<?php Echo $this->widget_id ?>') .find('h3').unbind().css('cursor', 'default').end() .find('.handlediv').remove(); $('#<?php Echo $this->widget_id ?>') .css('border-color', '#e66f00') .find('p').css('font-size', '1em'); $('#<?php Echo $this->widget_id ?> .toggle-message').click(function(){$(this).parent().slideUp(); $('#<?php Echo $this->widget_id ?> .inside>ul').slideDown(); }); $('#<?php Echo $this->widget_id ?> .inside>ul').hide(); <?php EndIf ?> $('a.dh_contribution_show_amounts').click(function(){$('.dh_contribution_amount_select').slideUp(); $(this).next('.dh_contribution_amount_select').slideDown(); return false; }); $('.dh_contribution_send').click(function(){var $form=$('#dh_paypal_form'); var $this=$(this).parent(); $form .find('input[name=currency_code]') .val($this.find('.currency').val()).end() .find('input[name=amount]') .val($this.find('.amount').val()).end() .submit(); }); $('.dh_contribution_amount_select .currency, .dh_contribution_amount_select .amount').change(function(){$(this).parent().find('.dh_contribution_send').removeAttr('disabled'); }); });/*]]>*/</script><?php } Function Print_Form(){?><div style="display:none"> <form action="https://www.paypal.com/cgi-bin/webscr" id="dh_paypal_form" method="post" target="_blank"> <input type="hidden" name="cmd" value="_xclick" /> <input type="hidden" name="business" value="mail@dennishoppe.de" /> <input type="hidden" name="no_shipping" value="1" /> <input type="hidden" name="tax" value="0" /> <input type="hidden" name="no_note" value="0" /> <input type="hidden" name="lc" value="<?php Echo $this->t('US', 'Paypal Language Code') ?>" /> <input type="hidden" name="item_name" value="<?php Echo $this->t('Contribution to Dennis Hoppe') ?>" /> <input type="hidden" name="on0" value="<?php Echo $this->t('Reference') ?>" /> <input type="hidden" name="os0" value="<?php Echo $this->t('WordPress') ?>" /> <?php ForEach ($this->Get_Extension_Names(True) AS $index=>$extension) : ?> <input type="hidden" name="on<?php Echo ($index+1) ?>" value="<?php Echo $this->t('Plugin') ?>" /> <input type="hidden" name="os<?php Echo ($index+1) ?>" value="<?php Echo HTMLSpecialChars($extension) ?>" /> <?php EndForEach ?> <input type="hidden" name="on<?php Echo ($index+2) ?>" value="<?php Echo $this->t('Website') ?>" /> <input type="hidden" name="os<?php Echo ($index+2) ?>" value="<?php Echo HTMLSpecialChars(home_url()) ?>" /> <?php If (is_multisite()) : ?> <input type="hidden" name="on<?php Echo ($index+3) ?>" value="<?php Echo $this->t('MultiSite') ?>" /> <input type="hidden" name="os<?php Echo ($index+3) ?>" value="<?php Echo HTMLSpecialChars(DOMAIN_CURRENT_SITE) ?>" /> <?php EndIf ?> <input type="hidden" name="currency_code" value="" /> <input type="hidden" name="amount" value="" /> </form> </div><?php } Function Currency($name, $code, $symbol, $min_amount, $integer=False){$o=New StdClass; $o->name=$name; $o->code=$code; $o->symbol=$symbol; $o->min=Round($min_amount, 2); $o->integer=$integer; return $o; } Function Rand_Amount($amount, $min, $max){return Round(Rand ( 100 * $min * $amount, 100 * $max * $amount ) / 100, 2); } Function Build_Amount_List($currency){$list=Array(); $start=$amount=$this->Rand_Amount($currency->min, 0.91, 1.09); $end=16 * $currency->min; For( $amount=$start; $amount<=$end; $amount=$this->Rand_Amount($amount, 1.15, 1.35)){If ($currency->integer) $amount=Round($amount); $v=Number_Format($amount, 2, '.', ''); $c=$currency->symbol . ' ' . Number_Format($amount, 2); $list[$v]=$c; } return $list; } Function Print_Message(){If (Count($this->Get_Extension_Names())==0) return False; Global $current_user; get_currentuserinfo(); $arr_extension=$this->Get_Extension_Names(); $arr_currencies=Array ( $this->Currency ('United States Dollar', 'USD', 'US$', 8.60),$this->Currency ('Euro', 'EUR', '&euro;', 6.05),$this->Currency ('Pound Sterling', 'GBP', '&pound;', 5.92),$this->Currency ('Dollar Canadien', 'CAD', 'C$', 8.42),$this->Currency ('Yen', 'JPY', '&yen;', 693, True),$this->Currency ('Australian Dollar', 'AUD', 'A$', 8.19),$this->Currency ('Schweizer Franken', 'CHF', 'SFr', 7.21),$this->Currency ('Dansk krone', 'DKK', 'kr', 45.13),$this->Currency ('Norsk krone', 'NOK', 'kr', 47.11),$this->Currency ('Svensk krona', 'SEK', 'kr', 55.63),$this->Currency ('New Zealand Dollar', 'NZD', 'NZ$', 10.59),$this->Currency ('Polski złoty', 'PLN', 'zł', 24.15),$this->Currency ('Hong Kong Dollar', 'HKD', 'HK$', 67.01),$this->Currency ('Singapore Dollar', 'SGD', 'SG$', 10.65),$this->Currency ('Magyar forint', 'HUF', 'Ft', 1625, True),$this->Currency ('Koruna česká', 'CZK', 'korun', 147.25),$this->Currency ('שקל חדש', 'ILS', '₪', 29.60),$this->Currency ('peso mexicano', 'MXN', 'MX$', 102.21),$this->Currency ('piso', 'PHP', 'P', 374.09),$this->Currency ('新臺幣', 'TWD', 'NT$', 250, True),$this->Currency ('บาท', 'THB', '฿', 264.36) ); If (File_Exists(DirName(__FILE__).'/contribution.png')) : ?> <img src="<?php Echo $this->base_url ?>/contribution.png" alt="Piggybank" title="Piggybank" class="alignright" style="margin-left:10px" /> <?php EndIf ?> <div style="text-align:justify"> <?php If ($this->is_dashboard) : ?><h4><?php Else: ?><h3><?php EndIf ?> <?php PrintF ( $this->t('Hello %1$s!'),$current_user->display_name ) ?></h4> <?php If ($this->is_dashboard) : ?></h4><?php Else: ?></h3><?php EndIf ?> <p> <?php PrintF ($this->t('You can use and test %s without any limitation of functionality or availability for your personal purposes.'),$this->Extended_Implode ($arr_extension, ', ', ' ' . $this->t('and') . ' ')) ?> </p> <p> <?php Echo $this->t('Please take a share in research and development costs by paying a service charge in order to remove this message.') ?> </p> <?php If ($this->is_dashboard) : ?> <p><input type="button" value="<?php _e('More...') ?>" class="button-secondary toggle-message" /></p> <?php EndIf ?> </div> <ul> <li><?php Echo $this->t('Contribute something from the Amazon Wish List') ?>: <ul> <li>&raquo; <a href="http://amzn.com/w/1A45MS7KY75CY" title="<?php Echo $this->t('Amazon USA') ?>" target="_blank"><?php Echo $this->t('Amazon USA') ?></a></li> <li>&raquo; <a href="http://www.amazon.de/wishlist/2AG0R8BHEOJOL" title="<?php Echo $this->t('Amazon Germany') ?>" target="_blank"><?php Echo $this->t('Amazon Germany') ?></a></li> </ul> </li> <li class="hide-if-js"><?php Echo $this->t('Make the contribution via PayPal') ?>: <ul> <li>&raquo; <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=1220480" target="_blank">United States dollar ($)</a></li> <li>&raquo; <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=U49F54BMWKNHU" target="_blank">Pound sterling (&pound;)</a></li> <li>&raquo; <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=HECSPGLPTQL24" target="_blank">Euro (&euro;)</a></li> </ul> </li> <li class="hide-if-no-js"><?php Echo $this->t('Make the contribution via PayPal') ?>: <ul> <?php ForEach ($arr_currencies AS $currency) : ?> <li>&raquo; <a href="#" title="<?php PrintF($this->t('Make the contribution in %s'),$currency->name) ?>" class="dh_contribution_show_amounts"><?php Echo $currency->name ?> (<?php Echo $currency->symbol ?>)</a> <div class="dh_contribution_amount_select hide-if-js"> <?php Echo $this->t('Amount') ?>: <input type="hidden" class="currency" value="<?php Echo $currency->code ?>" /> <select class="amount"> <option value="" disabled="disabled" selected="selected"><?php PrintF($this->t('Amount in %s'),$currency->code) ?>&nbsp;</option> <?php ForEach($this->Build_Amount_List($currency) AS $v=>$c) : ?> <option value="<?php Echo $v ?>"><?php Echo $c ?>&nbsp;</option> <?php EndForEach ?> </select> <input type="button" class="dh_contribution_send button-primary" value="<?php Echo $this->t('Proceed to PayPal') ?> &rarr;" title="<?php Echo $this->t('Proceed to PayPal') ?>" disabled="disabled" /> </div> </li> <?php EndForEach; ?> </ul> </li> <li> <?php If ($this->is_dashboard && current_user_can('activate_plugins')) : ?> <div class="remove-notification" style="text-align:right"> <form action="<?php Echo Admin_Url('plugins.php') ?>" method="post"> <input type="hidden" name="action" value="deactivate-selected"> <?php WP_Nonce_Field( 'bulk-plugins' ); ?> <?php ForEach ($this->Get_Extension_Files() AS $plugin_file) : ?> <input type="hidden" name="checked[]" value="<?php Echo $plugin_file ?>"> <?php EndForEach; ?> <p> <input type="submit" value="<?php If (Count($arr_extension)==1) Echo $this->t('I do not like this Plugin. Deactivate it!'); Else Echo $this->t('I do not like these Plugins. Deactivate them!') ?>" class="button"> </p> </form> </div> <?php EndIf ?> </li> </ul> <div class="clear"></div><?php } Function Add_Voucher_Field (){If (Count($this->Get_Extension_Names()) <1) return; Add_Settings_Field( __CLASS__, $this->t('Voucher Code'),Array($this, 'Print_Voucher_Code_Field'),'general' ); } Function Print_Voucher_Code_Field(){?> <input type="text" name="dh_contribution_code" size="32" value="<?php Echo get_option('dh_contribution_code') ?>" /><br /> <span class="description"><?php Echo $this->t('Please enter your personal Voucher Code.'); ?></span> <?php } } New dh_contribution; }